\documentclass[11pt,letterpaper,onecolumn]{scrartcl}
\usepackage{tocloft}
\usepackage{stdclsdv}
\usepackage{comment}
\usepackage{vmargin}
\usepackage{t1enc}
\usepackage{fancyvrb}
\usepackage{url}
\usepackage{calc}
\usepackage{array}
\usepackage{graphicx}
\usepackage{color}
\usepackage{listings}
\usepackage[latin1]{inputenc}
\usepackage[english]{babel}
\usepackage{supertabular}
\usepackage{fancyhdr}
\usepackage{multicol}
\usepackage{float}
\usepackage{textcomp}
\usepackage{alltt}
\definecolor{LstColor}{cmyk}{0.1,0.1,0,0.025} 
\setcounter{tocdepth}{1}
\ifx\pdfoutput\undefined
\usepackage[ps2pdf,
            pagebackref=true,
            colorlinks=true,
            linkcolor=blue
           ]{hyperref}
\usepackage{pspicture}
\else
\usepackage[pdftex,
            pagebackref=true,
            colorlinks=true,
            linkcolor=blue,
            pdfpagelabels,
            pdfstartpage=2
           ]{hyperref}
\fi
\renewcommand{\headheight}{14pt}

\begin{document}
\begin{sloppypar}

\lstset{language=c++,basicstyle=\ttfamily\tiny,commentstyle=\ttfamily\tiny,tabsize=2,breaklines,backgroundcolor=\color{LstColor},fontadjust=true,keepspaces=false,fancyvrb=true,showstringspaces=false,moredelim=[is][\textbf]{\\emph\{}{\}}}.
\title{Csound Windows Build}
\author{Michael Gogins \\ \texttt{gogins@pipeline.com}}
\maketitle

\section{Introduction}
\label{sec:Introduction}

This file should be updated in reasonable detail with each release of the Windows installers for Csound, in order to provide instructions for building Csound on Windows.

Csound on Windows is built using MinGW/MSys from (\url{www.mingw.org}). Code is built for release, with full optimizations including intrinsics and vectorization.  

These optimizations preclude debugging. A separate debug build must be made in order to debug. However, the only differences between the debug build and the release build must be the presence or absence of optimizations and the generation or not of debugging information. Code generation for both builds must be for ``release versions'' of the runtime libraries and third party libraries. This code generation standard also applies, of course, to actually building the third party libraries.

All third party libraries will be updated from the most recent version that seems to be used by a majority of their users --- whatever that is (trunk, most recent tag, stable release, whatever). If pre-built binaries are available, use them; otherwise, build with the recommended toolchain and build system. If that doesn't work, create a Microsoft Visual C++ solution. If that doesn't work, create an SConstruct file. In practice, I build all third party libraries Microsoft Visual C++ Express Edition except for liblo and FLTK, which I build with MinGW/MSys.

\section{Build Steps}
\label{sec:BuildSteps}

\begin{enumerate}
	\item (Done) Update the documentation tools.
		\begin{enumerate}
	    \item (No need) Update the Docbook toolchain.
	    \item (Done) Update LaTeX to the current version (2.2-071608) from proTeXt at \url{http://www.tug.org/protext}.
	    \item (Done) Update Doxygen to the current version (1.5.6) from \url{http://www.stack.nl/~dimitri/doxygen}.
	    \item (Done) Update ATT Graphviz to version 2.8 from \url{http://www.graphviz.org}. Later versions of Graphviz \texttt{dot} do not work with current Doxygen.
		\end{enumerate}
	\item (Done) Update the build tools.   
		\begin{enumerate}
			\item (Done) For Visual C++ from \url{http://www.microsoft.com/express/vc}, probably 2008 is still good (it is as of 6 September 2008). 
			\item For MinGW/MSys from \url{www.mingw.org}, update to MinGW version 4.2.1-2 with dw exception handling from \url{http://sourceforge.net/projects/mingw} (Done). Then add the latest MSys base and MSys supplementary tools from \url{http://sourceforge.net/projects/mingw}.
			\item (Done) Also install \texttt{dirent.h} from \url{http://www.softagalleria.net/dirent.php} and \texttt{bufferoverflowu.lib}  from Microsoft.
		\end{enumerate}    
	\item (Done) Update third-party dependencies.   
		\begin{enumerate}
  		\item (Done) Update Python from \url{www.python.org} to the most recent ``standard'' version (currently 2.5.2).
	    \item (Done) Update the Java Development Kit from \url{http://java.sun.com/javase/downloads/index.jsp} to the most recent ``standard'' version (currently Java SE 6 Update 10 RC).
	    \item (Done) Update SCons from \url{www.scons.org} to the most recent ``standard'' version (currenty 1.0.0).
	    \item (Done) Update SWIG from \url{www.swig.org} to the most recent ``standard'' version (currently 1.3.36).
			\item (Done) Update libsndfile from \url{http://www.mega-nerd.com/libsndfile}. Try the most recent pre-release version first (currently 1.0.18pre22a); if that doesn't work, use the latest stable release (currently 1.0.17). Do not build from sources. 
	    \item (Done) Update the pthread library from \url{http://sources.redhat.com/pthreads-win32} to the most recent stable version (currently 2.8.0). Build using \texttt{nmake clean VC-inlined} (to build the MSVC inlined dll with C cleanup code). Copy the DLL and lib into the pre-built directory. Copy those files and rename them \texttt{pthread.dll} and \texttt{pthread.lib}.
			\item (Done) Update the PortAudio library (\url{http://portmedia.sourceforge.net}) from SVN and build it. Try the trunk version first, if that doesn't work use the most recent tag. Patch PortAudio's \texttt{combase.h} by commenting out lines 219 through 227 (redeclarations of interlocked functions). Copy \verb|portaudio_x86.lib| to \verb|portaudio.lib|.
			\item (Done) Update the PortMidi library (\url{http://portmedia.sourceforge.net}) from SVN and build it.
    	\item (Done) Update FLTK from \url{www.fltk.org} to \texttt{branch-1.3 HEAD} from SVN and build it with MinGW using \verb|./configure --enable-threads --enable-shared|. Make sure that \texttt{custom-mingw.py} searches FLTK's \texttt{src} directory for import libraries before it searches FLTK's \texttt{lib} directory for static libraries (both are required).
    	\item (Done) Update boost from \url{www.boost.org} to the most recent stable version (currently 1.36.0).
    	\item (Done) Update FluidSynth from \url{http://fluidsynth.resonance.org/trac} to the most recent stable version (currently 1.0.8). Apply patches from the FluidSynth mailing list on trac. Build it with Visual C++.
    	\item (Done) Update the Synthesis Toolkit in C++ (STK) from \url{http://ccrma.stanford.edu/software/stk} to the most recent version (currently 4.3.1). Apply any patches from the web site and mailing list. Copy all contents of the STK directory into the Csound \texttt{Opcodes} directory.
    	\item (Done) Install the VST SDK 2.4 from \url{http://www.steinberg.net/en/company/3rd_party_developer.html}.
    	\item (Done) Update liblo version 0.24 (later versions call \verb|inet_aton| which doesn't exist on Windows) from \url{http://liblo.sourceforge.net} SVN and build it using my \texttt{SConstruct} file and MinGW.
    	\item (Done) Update LuaJIT from \url{http://luajit.org} to the most recent stable version (currently 1.1.4) and build it in the MSVC shell using \url{etc/luavs.bat}.
		\end{enumerate}
	\item (Done) Build   
		\begin{enumerate}				
			\item (Done) Double precision sample build.
				\begin{enumerate}
		    	\item (Done) Update \texttt{custom-mingw.py} and \texttt{custom-msvc.py} to reflect the locations of third-party header files and libraries.
					\item (Done) Update Csound from CVS at \verb|csound.cvs.sourceforge.net:/cvsroot/csound|, module \texttt{csound5}..
					\item (Done) Update \emph{The Canonical Csound Reference Manual} from CVS at \verb|csound.cvs.sourceforge.net:/cvsroot/csound|, module \texttt{manual}.
					\item (Done) Run \texttt{./cleanup.sh} to make everything really clean.
			    \item (Done) Build Csound using \texttt{build-mingw-release-double.bat}. You will have to make some additional patches to the STK sources for the updated MinGW compiler. The patches should be obvious from context. Mostly you need to \verb|#include <some_std_header>|.
			    \item (Done) Build again as above, to ensure \texttt{csnd.jar} is built properly.
			    \item (Done) Change to \texttt{examples/java} and execute \texttt{make} to build example jars.
			    \item (Done) Build the manual.
			    \item (Done) Build the API reference by executing \texttt{doxygen}.
			    \item (Done) Execute \texttt{strip.sh} to strip debugging information out of the binaries.
			    \item (Done) Build the installer using NSIS from \url{http://nsis.sourceforge.net/Main_Page} \emph{with} the \verb|NONFREE| (VST) stuff.  
			    \item (Done) Uninstall Csound, and install it again using the installer. Use the Microsoft Dependency Walker and profile \texttt{csound5gui} running to verify that all DLLs required have been installed, or are already part of Windows.
			    \item (Done) Build the installer \texttt{without} the \verb|NONFREE| stuff.   
				\end{enumerate}
			\item Single precision sample build.			
				\begin{enumerate}
					\item Repeat all procedures above, omitting the \verb|NONFREE| stuff, in a separate directory using \texttt{build-mingw-release-float.bat}. 
				\end{enumerate}
	    \item (Done) Update this document to reflect any changes in procedure or dependencies. 
	    \item Upload the installers to SourceForge and update the release package.
		\end{enumerate}
 \end{enumerate}

\section{Bug Fixes and Tests}
\label{sec:BugFixesAndTests}

\begin{enumerate}
	\item (Done) Move \texttt{spoutlock} and \texttt{spinlock} to dummy slots in CSOUND structure to preserve Csound API compatibility.
	\item (Done) Change \texttt{SConstruct} to define \verb|FL_DLL| for linking with the FLTK DLL.
	\item (Done) Change \texttt{SConstruct} to define \verb|_SCL_SECURE_NO_DEPRECATE| for compiling Gmm++.
	\item (Done) Ensure \texttt{csound /examples/trapped.csd} works.
	\item (Done) Ensure \texttt{csound /examples/trapped.csd -otrapped.wav} works.
	\item (Done) Ensure Python works with \texttt{python examples/koch.py}, which uses SoundFonts in FluidSynth opcodes, and \texttt{python examples/Lindenmayer.py}, which uses \texttt{CsoundAC}. 
	\item (Done) Ensure Lua works with \verb|luajit examples/lua_example.lua|.
	\item (Done) Ensure Lisp works with \verb|clisp interfaces/test.lisp|.
	\item (Done) Ensure Java works with \verb|java -jar examples\java\CsoundEditor.jar|.
	\item (Done) Ensure \texttt{CsoundVstShell} can load \texttt{examples/CsoundAC.csd} and perform as a live MIDI instrument using a SoundFont in a FluidSynth instrument, and an STK instrument.
	\item (Done) Ensure the Python opcodes work with some of the files in \url{Opcodes/py/examples}.
	\item (Done) Fix score editing bug in \texttt{csound5gui}.
	\item (Done) Ensure \texttt{csound5gui} renders \texttt{trapped.csd} to audio, and can be stopped and restarted.
	\item (Done) Ensure \texttt{csound5gui} renders \texttt{trapped.csd} to soundfile, and can be stopped and restarted. 	
	\item (Done) Ensure FLTK widgets work. 	
	\item (Done) Ensure VST hosting works using \verb|CsoundAC-midi.csd|. Fixed a bug with real-time notes not ending, by restoring \texttt{relesing} flag. This needs to be tested for file rendering.
	\item (Done) Ensure OSC works using example files.
	\item (Done) Fix up installers for correct third party DLLs.
	\item (Done) Fix up installers for correct Csound examples.
	\item (Done) Make sure installers link to the frames version of the manual and include the quick reference.
	\item (Done) Ensure \texttt{CsoundVST} plugin works with \texttt{CsoundVST.csd} in VSTHost from \url{http://www.hermannseib.com/english/vsthost.htm}.
\end{enumerate}

\end{sloppypar}
\end{document}

