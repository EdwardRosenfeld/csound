
USEDOUBLE = no

CC = wine D:/MinGW/bin/gcc
CXX = wine D:/MinGW/bin/g++
CFLAGS = -Wall -O3 -fno-inline-functions
ifeq ($(strip $(USEDOUBLE)),yes)
CFLAGS += -march=i586 -mtune=pentium3 -fomit-frame-pointer -ffast-math
CFLAGS += -DUSE_DOUBLE -DUSE_LRINT
CSOUNDLIB = csound64.dll
PROGRAM = csound.exe
else
CFLAGS += -march=pentium3 -fomit-frame-pointer -ffast-math
CSOUNDLIB = csound32.dll
PROGRAM = csound32.exe
endif
CFLAGS += -I. -IH -DWIN32 -DPIPES -DHAVE_STDINT_H -DHAVE_DIRENT_H
CFLAGS += -DHAVE_UNISTD_H -DHAVE_FCNTL_H -DHAVE_SYS_TIME_H -DHAVE_SYS_TYPES_H
CFLAGS += -DPIC
LDFLAGS = -L.
LIBS = D:/MinGW/bin/libsndfile-1.dll -lgdi32 -luser32 -lkernel32 -lm
PYINCDIR = D:/MinGW/Python/include
PYLIB = python24.dll

PLUGINS =	ftest.dll mixer.dll modal4.dll physmod.dll pitch.dll	\
		scansyn.dll sfont.dll stdopcod.dll stdutil.dll		\
		widgets.dll rtpa.dll rtwinmm.dll pmidi.dll

UTILS =		cvanal.exe dnoise.exe hetro.exe lpanal.exe mixer.exe	\
		pvanal.exe scale.exe sndinfo.exe srconv.exe		\
		extractor.exe scsort.exe extract.exe csb64enc.exe	\
		makecsd.exe cs.exe scot.exe

all: $(CSOUNDLIB) $(PROGRAM) $(PLUGINS) $(UTILS)

CSOUNDLIB_OBJ =	Engine/auxfd.o Engine/cfgvar.o Engine/entry1.o		\
		Engine/envvar.o Engine/express.o Engine/extract.o	\
		Engine/fgens.o Engine/insert.o Engine/linevent.o	\
		Engine/memalloc.o Engine/memfiles.o Engine/musmon.o	\
		Engine/namedins.o Engine/otran.o Engine/rdorch.o	\
		Engine/rdscor.o Engine/scsort.o Engine/scxtract.o	\
		Engine/sort.o Engine/sread.o Engine/swrite.o		\
		Engine/twarp.o InOut/libsnd.o InOut/libsnd_u.o		\
		InOut/midifile.o InOut/midirecv.o InOut/midisend.o	\
		InOut/winascii.o InOut/windin.o InOut/window.o		\
		InOut/winEPS.o OOps/aops.o OOps/bus.o OOps/cmath.o	\
		OOps/diskin2.o OOps/diskin.o OOps/disprep.o		\
		OOps/dsputil.o OOps/dumpf.o OOps/fftlib.o		\
		OOps/goto_ops.o OOps/midiinterop.o OOps/midiops.o	\
		OOps/midiout.o OOps/mxfft.o OOps/oscils.o		\
		OOps/pstream.o OOps/pvadd.o OOps/pvfileio.o		\
		OOps/pvinterp.o OOps/pvocext.o OOps/pvread.o		\
		OOps/pvsanal.o OOps/random.o OOps/schedule.o		\
		OOps/sndinfUG.o OOps/str_ops.o OOps/ugens1.o		\
		OOps/ugens2.o OOps/ugens3.o OOps/ugens4.o OOps/ugens5.o	\
		OOps/ugens6.o OOps/ugens8.o OOps/ugrw1.o OOps/ugrw2.o	\
		OOps/vbap_eight.o OOps/vbap_four.o OOps/vbap.o		\
		OOps/vbap_sixteen.o OOps/vbap_zak.o OOps/vdelay.o	\
		OOps/vpvoc.o Top/argdecode.o Top/cscore_internal.o	\
		Top/cscorfns.o Top/csmodule.o Top/csound.o		\
		Top/getstring.o Top/main.o Top/new_opts.o		\
		Top/one_file.o Top/opcode.o Top/threads.o Top/utility.o

$(CSOUNDLIB): $(CSOUNDLIB_OBJ)
	$(CXX) -O2 -shared -Wl,--output-def,$(subst .dll,.def,$(CSOUNDLIB)) -o $@ $^ $(LDFLAGS) $(LIBS)

Opcodes/%.o: Opcodes/%.c
	$(CC) $(CFLAGS) -c $< -o $@

%.o: %.c
	$(CC) -D__BUILDING_LIBCSOUND $(CFLAGS) -c $< -o $@

%.oo: %.cpp
	$(CXX) $(CFLAGS) -c $< -o $@

Opcodes/sfont.o: Opcodes/sfont.c
	$(CC) $(CFLAGS) -fno-strict-aliasing -c $< -o $@

modal4.dll: Opcodes/modal4.o Opcodes/physutil.o
	$(CC) -O2 -shared -o $@ $^ $(LDFLAGS) $(LIBS)

physmod.dll: Opcodes/physmod.o Opcodes/physutil.o Opcodes/mandolin.o	\
	     Opcodes/singwave.o Opcodes/fm4op.o Opcodes/moog1.o		\
	     Opcodes/shaker.o Opcodes/bowedbar.o
	$(CC) -O2 -shared -o $@ $^ $(LDFLAGS) $(LIBS)

stdopcod.dll:	Opcodes/ambicode.o Opcodes/babo.o Opcodes/bbcut.o	\
		Opcodes/biquad.o Opcodes/butter.o Opcodes/clfilt.o	\
		Opcodes/cross2.o Opcodes/dam.o Opcodes/dcblockr.o	\
		Opcodes/filter.o Opcodes/flanger.o Opcodes/follow.o	\
		Opcodes/fout.o Opcodes/freeverb.o Opcodes/ftconv.o	\
		Opcodes/ftgen.o Opcodes/gab/gab.o			\
		Opcodes/gab/vectorial.o Opcodes/grain.o			\
		Opcodes/grain4.o Opcodes/hrtferX.o Opcodes/ifd.o	\
		Opcodes/locsig.o Opcodes/lowpassr.o Opcodes/metro.o	\
		Opcodes/midiops2.o Opcodes/midiops3.o Opcodes/newfils.o	\
		Opcodes/nlfilt.o Opcodes/oscbnk.o Opcodes/partials.o	\
		Opcodes/phisem.o Opcodes/pluck.o Opcodes/psynth.o	\
		Opcodes/pvsbasic.o Opcodes/pvscent.o Opcodes/pvsdemix.o	\
		Opcodes/repluck.o Opcodes/reverbsc.o Opcodes/seqtime.o	\
		Opcodes/sndloop.o Opcodes/sndwarp.o Opcodes/space.o	\
		Opcodes/spat3d.o Opcodes/syncgrain.o Opcodes/ugens7.o	\
		Opcodes/ugens9.o Opcodes/ugensa.o Opcodes/uggab.o	\
		Opcodes/ugmoss.o Opcodes/ugnorman.o Opcodes/ugsc.o	\
		Opcodes/wave-terrain.o					\
		Opcodes/stdopcod.o
	$(CC) -O2 -shared -o $@ $^ $(LDFLAGS) $(LIBS)

scansyn.dll: Opcodes/scansyn.o Opcodes/scansynx.o
	$(CC) -O2 -shared -o $@ $^ $(LDFLAGS) $(LIBS)

pitch.dll: Opcodes/pitch.o Opcodes/pitch0.o Opcodes/spectra.o
	$(CC) -O2 -shared -o $@ $^ $(LDFLAGS) $(LIBS)

mixer.dll: Opcodes/mixer.oo
	$(CXX) -O2 -shared -o $@ $< $(LDFLAGS) -lstdc++ -lole32 -luuid -lwsock32 $(LIBS)

widgets.dll: InOut/FL_graph.oo InOut/winFLTK.o InOut/widgets.oo
	$(CXX) -O2 -shared -o $@ $^ $(LDFLAGS) -lfltk -lstdc++ -lole32 -luuid -lwsock32 $(LIBS)

rtpa.dll: InOut/rtpa.o
	$(CC) -O2 -shared -o $@ $< $(LDFLAGS) D:/MinGW/lib/portaudio.dll -lwinmm -ldsound -lole32 $(LIBS)

rtwinmm.dll: InOut/rtwinmm.o
	$(CC) -O2 -shared -o $@ $< $(LDFLAGS) -lwinmm $(LIBS)

pmidi.dll: InOut/pmidi.o
	$(CC) -O2 -shared -o $@ $< $(LDFLAGS) -lportmidi -lporttime -lwinmm $(LIBS)

stdutil.dll:	util/cvanal.o util/dnoise.o util/envext.o util/xtrct.o	\
		util/het_export.o util/het_import.o util/hetro.o	\
		util/lpanal.o util/lpc_export.o util/lpc_import.o	\
		util/mixer.o util/pvanal.o util/pvlook.o util/scale.o	\
		util/sndinfo.o util/srconv.o				\
		util/std_util.o
	$(CC) -O2 -shared -o $@ $^ $(LDFLAGS) $(LIBS)

%.dll: Opcodes/%.o
	$(CC) -O2 -shared -o $@ $< $(LDFLAGS) $(LIBS)

$(PROGRAM): frontends/csound/csound_main.o $(CSOUNDLIB)
	$(CXX) -O2 -o $@ $< $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

cvanal.exe: util/cvl_main.o
	$(CXX) -O2 -o $@ $< $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

dnoise.exe: util/dnoise_main.o
	$(CXX) -O2 -o $@ $< $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

hetro.exe: util/het_main.o
	$(CXX) -O2 -o $@ $< $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

lpanal.exe: util/lpc_main.o
	$(CXX) -O2 -o $@ $< $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

mixer.exe: util/mixer_main.o
	$(CXX) -O2 -o $@ $< $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

pvanal.exe: util/pvl_main.o
	$(CXX) -O2 -o $@ $< $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

scale.exe: util/scale_main.o
	$(CXX) -O2 -o $@ $< $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

sndinfo.exe: util/sndinfo_main.o
	$(CXX) -O2 -o $@ $< $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

srconv.exe: util/srconv_main.o
	$(CXX) -O2 -o $@ $< $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

extractor.exe: util/xtrc_main.o
	$(CXX) -O2 -o $@ $< $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

scsort.exe: util1/sortex/smain.o
	$(CXX) -O2 -o $@ $< $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

extract.exe: util1/sortex/xmain.o
	$(CXX) -O2 -o $@ $< $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

csb64enc.exe: util1/csd_util/base64.o util1/csd_util/csb64enc.o
	$(CXX) -O2 -o $@ $^ $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

makecsd.exe: util1/csd_util/base64.o util1/csd_util/makecsd.o
	$(CXX) -O2 -o $@ $^ $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

cs.exe: util1/csd_util/cs.o
	$(CXX) -O2 -o $@ $< $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

scot.exe: util1/scot/scot.o util1/scot/scot_main.o
	$(CXX) -O2 -o $@ $^ $(LDFLAGS) $(CSOUNDLIB) $(LIBS)

Opcodes/py/pythonopcodes.o: Opcodes/py/pythonopcodes.c
	$(CC) $(CFLAGS) -I$(PYINCDIR) -c $< -o $@

py.dll: Opcodes/py/pythonopcodes.o
	$(CC) -O2 -shared -o $@ $< $(LDFLAGS) $(PYLIB) $(LIBS)

wrappers: _csnd.dll _jcsound.dll

interfaces/java_interface_wrap.oo: interfaces/java_interface_wrap.cc
	$(CXX) $(CFLAGS) -fno-strict-aliasing -D__BUILDING_CSOUND_INTERFACES -Iinterfaces -c $< -o $@

interfaces/python_interface_wrap.oo: interfaces/python_interface_wrap.cc
	$(CXX) $(CFLAGS) -fno-strict-aliasing -D__BUILDING_CSOUND_INTERFACES -I$(PYINCDIR) -Iinterfaces -c $< -o $@

_csnd.dll:	interfaces/filebuilding.oo interfaces/CppSound.oo	\
		interfaces/CsoundFile.oo interfaces/cs_glue.oo		\
		interfaces/csPerfThread.oo interfaces/pyMsgCb.oo	\
		interfaces/python_interface_wrap.oo $(CSOUNDLIB)
	$(CXX) -O2 -shared -o $@ $^ $(LDFLAGS) -Wl,--add-stdcall-alias -Wl,--output-def,_csnd.def -lstdc++ $(PYLIB) $(LIBS)

_jcsound.dll:	interfaces/filebuilding.oo interfaces/CppSound.oo	\
		interfaces/CsoundFile.oo interfaces/cs_glue.oo		\
		interfaces/csPerfThread.oo interfaces/pyMsgCb_stub.oo	\
		interfaces/java_interface_wrap.oo $(CSOUNDLIB)
	$(CXX) -O2 -shared -o $@ $^ $(LDFLAGS) -Wl,--add-stdcall-alias -Wl,--output-def,_jcsound.def -lstdc++ $(LIBS)

clean:
	-rm `find . -type f \( -name "*.o" -o -name "*.oo" \) -print`
	-rm `find . -type f \( -name "*.a" -o -name "*.dll" \) -print`
	-rm `find . -type f \( -name "*.exe" -o -name "*.xmg" \) -print`
	-rm csound32.def csound64.def _csnd.def csnd.py csnd.pyc csnd.pyo
	-rm _jcsound.def
	-rm interfaces/python_interface_wrap.cc
	-rm interfaces/python_interface_wrap.h
	-rm interfaces/java_interface_wrap.cc
	-rm interfaces/java_interface_wrap.h

